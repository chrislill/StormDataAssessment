---
title: "Storm Data Assignment"
author: "Chris Lill"
date: "18 July 2015"
output: html_document
---

## Synopsis



## Data Processing

```{r Download, cache = TRUE}
storm.url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(storm.url, "StormData.csv.bz2")
storm.data <- read.table("StormData.csv.bz2", header = TRUE, sep = ",")
```

A function is needed to interpret the `PROPDMGEXP` and `CROPDMGEXP` fields which multiply `PROPDMG` and `CROPDMG` by varying powers of 10. `damage(x, y)` calculates the actual damage of `x*(10^y)` where x is the coefficient (`PROPDMG`) and y is the exponent (`PROPDMGEXP`). 
```{r Damage}
damage <- function(x, y) {
    exp <- ifelse(is.numeric(y), 
                  y,
                  ifelse(y %in% c("h", "H"),
                         2,
                         ifelse(y %in% c("k", "K"),
                                3,
                                ifelse(y %in% c("m", "M"),
                                       6,
                                       ifelse(y %in% c("b", "B"),
                                              9,
                                              0
                                              )
                                       )
                                )
                         )
                  )
    x * (10 ^ exp)
}
```

To quantify the effect on population health (`people`) we will add the number of fatalities and injuries. To quantify the cost (`cost`) we will add the property and crop damages.
```{r Processing}
suppressMessages(library(dplyr))
storm.summary <- storm.data %>%
    group_by(EVTYPE) %>%
    mutate(property = damage(PROPDMG, PROPDMGEXP),
           crop = damage(CROPDMG, CROPDMGEXP)) %>%
    summarize(people = sum(FATALITIES + INJURIES), 
              fatalities = sum(FATALITIES),
              injuries = sum(INJURIES),
              property = sum(property),
              crop = sum(crop),
              cost = sum(property + crop))
storm.bypeople <- arrange(storm.summary, desc(people))
storm.bycost <- arrange(storm.summary, desc(cost))
```


## Results
The 20 types of events which are most 

```{r PeopleTable, results="asis"}
library(xtable)
xt <- xtable(storm.bypeople[1:20,1:4], 
             digits = 0,
             caption = "Types of events with greatest impact on population health")
print(xt, type="html")
```

More text here

```{r CostTable, results="asis"}
library(xtable)
xt <- xtable(storm.bycost[1:20,c(1, 7, 5, 6)], 
             digits = 0,
             caption = "Types of events with greatest economic consequences")
print(xt, type="html")
```

To identify the types of events which the US should prioritize resources for, the plot below shows the top 10 event types in terms of population and economic impact. The scales are relative (and on a logarithmic scale).

```{r PlotImpact}
library(tidyr)
tenth.people <- storm.bypeople[[10, "people"]]
tenth.cost <- storm.bycost[[10, "cost"]]
max.people <- max(storm.summary$people)
max.cost <- max(storm.summary$cost)
storm.plot <- storm.summary %>%
    filter(people >= tenth.people | cost >= tenth.cost) %>%
    transmute(EVTYPE, people, cost) %>%
    mutate(people = log10(people/max.people),
           cost = log10(cost/max.cost)) %>%
    arrange(people) %>%
    gather(type, damage, -EVTYPE)

# Reorder the levels of the EVTYPE factor so that events are plotted in descending levels of population impact.
storm.plot$EVTYPE <- with(storm.plot, factor(EVTYPE, unique(EVTYPE)))
levels(storm.plot$type) <-  c("Population", "Economic")

library(ggplot2)
g <- ggplot(storm.plot, aes(x = EVTYPE, colour = type)) +
    geom_point(aes(y = damage), stat = "identity") +
    coord_flip(ylim = c(-6, 0.1)) +
    facet_wrap(~ type, ncol = 2) +
    scale_colour_brewer(type = "qual", palette = 6) +
    theme(legend.position = "none",
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()) +
    labs(title = "Relative impact of weather events across the US (logarithmic)",
         x = NULL,
         y = NULL)
g
    
    


```